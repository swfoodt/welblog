{{ $parent := .parent }}
{{ $tree := .tree }}
{{ $nodeMap := .nodeMap }}
{{ $current := .current }}
{{ $slug := .slug }}

{{ $children := index $tree $parent | default (slice) }}

{{ $entries := slice }}
{{ range $children }}
  {{ $path := . }}
  {{ $pages := index $nodeMap $path | default (slice) }}
  {{ $weight := 0 }}

  {{ if eq $path "/" }}
    {{ $rootMatches := where $pages "File.TranslationBaseName" "_index" }}
    {{ if gt (len $rootMatches) 0 }}
      {{ $weight = (index $rootMatches 0).Params.docmeta.weight | default 0 }}
    {{ end }}
  {{ else }}
    {{ $matches := where $pages "File.TranslationBaseName" "_index" }}
    {{ $indexPage := cond (gt (len $matches) 0) (index $matches 0) nil }}
    {{ if $indexPage }}
      {{ $weight = $indexPage.Params.docmeta.weight | default 0 }}
    {{ else if gt (len $pages) 0 }}
      {{ $first := index $pages 0 }}
      {{ $weight = $first.Params.docmeta.weight | default 0 }}
    {{ end }}
  {{ end }}

  {{ $entries = $entries | append (dict "path" $path "weight" $weight) }}
{{ end }}

{{ $sorted := sort $entries "weight" }}

{{ range $sorted }}
  {{ $path := .path }}
  {{ $pages := index $nodeMap $path | default (slice) }}
  {{ $segments := split (trim $path "/") "/" }}
  {{ $depth := cond (eq $path "/") 0 (len $segments) }}
  {{ $indent := printf "ml-%d" (add $depth 4) }}

  <div class="{{ $indent }} py-1" x-data="{ open: true }">
    <div class="cursor-pointer select-none" @click="open = !open">
      <span class="mr-1 text-sm" x-text="open ? '▼' : '▶'"></span>
      <a href="{{ printf "/docs%s" $path | relURL }}" class="text-gray-500 font-semibold hover:underline">
        {{ index (last 1 $segments) 0 }}
      </a>
    </div>

    <div x-show="open" class="ml-4 space-y-1">
      {{ range (sort (where $pages "File.TranslationBaseName" "!=" "_index") "Params.docmeta.weight") }}
        <div class="text-sm text-blue-500">
          <a href="{{ .RelPermalink }}"
             class="hover:underline {{ if eq .RelPermalink $current.RelPermalink }}font-bold text-black{{ end }}">
            {{ .Params.docmeta.title | default .Title }}
          </a>
        </div>
      {{ end }}

      {{ partial "docs/tree-recursive.html" (dict "parent" $path "tree" $tree "nodeMap" $nodeMap "current" $current "slug" $slug) }}
    </div>
  </div>
{{ end }}
