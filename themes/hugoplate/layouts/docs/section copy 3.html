{{ define "main" }}
  {{ partial "page-header" . }}

<section class="max-w-6xl mx-auto px-6 py-12">
  {{ $slug := .Params.slug }}
  {{ $pages := where site.Pages "Params.docmeta.id" $slug }}

  {{ $nodeMap := dict }}
  {{ range $pages }}
    {{ $path := .Params.docmeta.path | default "" | trim "/" | print "/" }}
    {{ $nodeMap = merge $nodeMap (dict $path .) }}
  {{ end }}

  {{ $allPaths := slice }}
  {{ range $pages }}
    {{ $raw := .Params.docmeta.path | default "" }}
    {{ $segments := split $raw "/" }}
    {{ $acc := "" }}
    {{ range $segments }}
      {{ if ne . "" }}
        {{ $acc = print $acc "/" . }}
        {{ if not (in $allPaths $acc) }}
          {{ $allPaths = $allPaths | append $acc }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ range $allPaths }}
    {{ if not (index $nodeMap .) }}
      {{ $nodeMap = merge $nodeMap (dict . nil) }}
    {{ end }}
  {{ end }}

  {{ $.Scratch.Set "tree" (dict) }}
  {{ range $allPaths }}
    {{ $parts := split (trim . "/") "/" }}
    {{ $parentParts := first (sub (len $parts) 1) $parts }}
    {{ $parent := cond (eq (len $parentParts) 0) "/" (print "/" (delimit $parentParts "/") "/") }}
    {{ $tree := $.Scratch.Get "tree" }}
    {{ $existing := index $tree $parent }}
    {{ if not $existing }}
      {{ $.Scratch.SetInMap "tree" $parent (slice .) }}
    {{ else }}
      {{ $.Scratch.SetInMap "tree" $parent (append $existing .) }}
    {{ end }}
  {{ end }}

  {{ $tree := $.Scratch.Get "tree" }}
  <p class="text-sm text-gray-400">treeï¼š{{ $tree }}</p>
  {{ partial "docs/tree-recursive.html" (dict "parent" "/" "tree" $tree "nodeMap" $nodeMap "current" .) }}
</section>



{{ end }}