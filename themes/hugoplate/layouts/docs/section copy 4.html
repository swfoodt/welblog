{{ define "main" }}
  {{ partial "page-header" . }}

<section class="max-w-6xl mx-auto px-6 py-12">
  {{ $slug := .Params.slug }}
  {{ $pages := where site.Pages "Params.docmeta.id" $slug }}

  {{/* 构造 nodeMap: path => page（文章节点） */}}
  {{ $nodeMap := dict }}
  {{ range $pages }}
    {{ $path := print "/" (trim (.Params.docmeta.path | default "") "/") "/" }}
    {{ $nodeMap = merge $nodeMap (dict $path .) }}
  {{ end }}

  {{/* 构造所有路径（含虚拟目录） */}}
  {{ $allPaths := slice }}
  {{ range $pages }}
    {{ $raw := .Params.docmeta.path | default "" }}
    {{ $segments := split $raw "/" }}
    {{ $acc := "" }}
    {{ range $segments }}
      {{ if ne . "" }}
        {{ $acc = print $acc "/" . }}
        {{ if not (in $allPaths $acc) }}
          {{ $allPaths = $allPaths | append $acc }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 确保所有中间路径也能被查到，即使无绑定文章 */}}
  {{ range $allPaths }}
    {{ $p := print "/" (trim . "/") "/" }}
    {{ if not (index $nodeMap $p) }}
      {{ $nodeMap = merge $nodeMap (dict $p nil) }}
    {{ end }}
  {{ end }}

  {{/* 构建 tree: parentPath => [childPaths] */}}
  {{ $.Scratch.Set "tree" (dict) }}
  {{ range $allPaths }}
    {{ $p := print "/" (trim . "/") "/" }}
    {{ $parts := split (trim $p "/") "/" }}
    {{ $parent := cond (gt (len $parts) 1)
      (print "/" (delimit (first (sub (len $parts) 1) $parts) "/") "/")
      "/" }}
    {{ $tree := $.Scratch.Get "tree" }}
    {{ $existing := index $tree $parent }}
    {{ if not $existing }}
      {{ $.Scratch.SetInMap "tree" $parent (slice $p) }}
    {{ else }}
      {{ $.Scratch.SetInMap "tree" $parent (append $existing $p) }}
    {{ end }}
  {{ end }}

  {{ $tree := $.Scratch.Get "tree" }}
  <p class="text-sm text-gray-400">tree：{{ $tree }}</p>
  <p class="text-sm text-gray-400">nodeMap：{{ $nodeMap }}</p>
  {{ partial "docs/tree-recursive.html" (dict "parent" "/" "tree" $tree "nodeMap" $nodeMap "current" .) }}
</section>




{{ end }}