name: Docker Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: 'latest'
        extended: true
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    
    - name: ðŸ”¨ Build Hugo site
      run: |
        echo "Building site..."
        npm run build
        
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Build failed: index.html not found"
          exit 1
        fi
        
        echo "âœ… Build completed successfully"
    
    - name: ðŸ³ Build Docker image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        echo "Building Docker image with tag: $SHORT_SHA"
        docker build -t welblog:$SHORT_SHA -t welblog:latest .
        
        echo "âœ… Docker image built successfully"
    
    - name: ðŸ§ª Test Docker container
      run: |
        echo "Starting test container..."
        docker run -d -p 8080:80 --name test-blog welblog:latest
        
        echo "Waiting for container to be ready..."
        sleep 5
        
        echo "Testing HTTP response..."
        curl -f http://localhost:8080 || exit 1
        
        echo "Checking container logs..."
        docker logs test-blog
        
        echo "Stopping test container..."
        docker stop test-blog
        docker rm test-blog
        
        echo "âœ… All tests passed!"
    
    - name: ðŸ“Š Generate summary
      run: |
        echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Short SHA**: \`$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: \`welblog:$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Size**: \`$(docker images welblog:latest --format '{{.Size}}')\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Container health check passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… HTTP response test passed" >> $GITHUB_STEP_SUMMARY