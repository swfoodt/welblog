name: Docker Build, Test and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_IMAGE: welblog
  ENABLE_DEPLOY: false  # é“¾æŽ¥åˆ°æœåŠ¡å™¨å¯åŠ¨éƒ¨ç½²æµç¨‹

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ===== æž„å»ºé˜¶æ®µ =====
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: 'latest'
        extended: true
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    
    - name: ðŸ”¨ Build Hugo site
      run: |
        echo "Building site..."
        npm run build
        
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Build failed: index.html not found"
          exit 1
        fi
        
        echo "âœ… Site build completed"
    
    - name: ðŸ³ Build Docker image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        echo "Building Docker image..."
        docker build \
          -t $DOCKER_USERNAME/$DOCKER_IMAGE:$SHORT_SHA \
          -t $DOCKER_USERNAME/$DOCKER_IMAGE:latest \
          .
        
        echo "âœ… Docker image built successfully"
        echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
    
    # ===== æµ‹è¯•é˜¶æ®µ =====
    - name: ðŸ§ª Test Docker container
      run: |
        echo "Starting test container..."
        docker run -d -p 8080:80 --name test-blog $DOCKER_USERNAME/$DOCKER_IMAGE:latest
        
        echo "Waiting for container..."
        sleep 5
        
        echo "Testing HTTP response..."
        curl -f http://localhost:8080 || exit 1
        
        echo "Checking container health..."
        docker ps | grep test-blog
        
        echo "Container logs:"
        docker logs test-blog
        
        echo "Cleaning up..."
        docker stop test-blog
        docker rm test-blog
        
        echo "âœ… All tests passed"
    
    # ===== æŽ¨é€é˜¶æ®µï¼ˆå¯é€‰ï¼‰=====
    - name: ðŸ“¤ Login to Docker Hub
      #if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ðŸ“¤ Push to Docker Hub
      #if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
      run: |
        echo "Pushing images to Docker Hub..."
        
        docker push $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}
        docker push $DOCKER_USERNAME/$DOCKER_IMAGE:latest
        
        echo "âœ… Images pushed successfully"
        echo "- $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}"
        echo "- $DOCKER_USERNAME/$DOCKER_IMAGE:latest"
    
    # ===== éƒ¨ç½²é˜¶æ®µï¼ˆå¯é€‰ï¼‰=====
    - name: ðŸš€ Deploy to server
      if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting deployment ==="
          
          # ç™»å½•Docker Hub
          echo "Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "Pulling latest image..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/welblog:latest
          
          # åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          echo "Stopping old container..."
          docker stop welblog-docker 2>/dev/null || echo "No container to stop"
          docker rm welblog-docker 2>/dev/null || echo "No container to remove"
          
          # å¯åŠ¨æ–°å®¹å™¨ï¼ˆç«¯å£8081ï¼Œä¸å½±å“ä¼ ç»Ÿéƒ¨ç½²çš„80ç«¯å£ï¼‰
          echo "Starting new container..."
          docker run -d \
            --name welblog-docker \
            -p 8081:80 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/welblog:latest
          
          # éªŒè¯éƒ¨ç½²
          echo "Waiting for container to start..."
          sleep 5
          
          echo "Verifying deployment..."
          docker ps | grep welblog-docker || exit 1
          curl -f http://localhost:8081 || exit 1
          
          # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°çš„2ä¸ªç‰ˆæœ¬ï¼‰
          echo "Cleaning up old images..."
          docker image prune -a -f --filter "until=72h" || true
          
          echo "=== Deployment successful ==="
          echo "Container running on port 8081"
    
    # ===== ç”ŸæˆæŠ¥å‘Š =====
    - name: ðŸ“Š Generate summary
      if: always()
      run: |
        echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Short SHA**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: \`$DOCKER_USERNAME/$DOCKER_IMAGE\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Size**: \`$(docker images $DOCKER_USERNAME/$DOCKER_IMAGE:latest --format '{{.Size}}')\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Status" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Container tests passed" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.ENABLE_DEPLOY }}" = "true" ]; then
          echo "- âœ… Pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployed to server (port 8081)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ Deployment skipped (ENABLE_DEPLOY=false)" >> $GITHUB_STEP_SUMMARY
        fi

# ç®€åŒ–ç‰ˆï¼ˆä»…æž„å»ºå’Œæµ‹è¯•ï¼‰
# ---------------------------------
# name: Docker Build and Test

# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]

# jobs:
#   build-and-test:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v4
    
#     - name: ðŸ”§ Setup Hugo
#       uses: peaceiris/actions-hugo@v3
#       with:
#         hugo-version: 'latest'
#         extended: true
    
#     - name: ðŸ”§ Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'
#         cache: 'npm'
    
#     - name: ðŸ“¦ Install dependencies
#       run: npm ci
    
#     - name: ðŸ”¨ Build Hugo site
#       run: |
#         echo "Building site..."
#         npm run build
        
#         if [ ! -f "public/index.html" ]; then
#           echo "âŒ Build failed: index.html not found"
#           exit 1
#         fi
        
#         echo "âœ… Build completed successfully"
    
#     - name: ðŸ³ Build Docker image
#       run: |
#         SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
#         echo "Building Docker image with tag: $SHORT_SHA"
#         docker build -t welblog:$SHORT_SHA -t welblog:latest .
        
#         echo "âœ… Docker image built successfully"
    
#     - name: ðŸ§ª Test Docker container
#       run: |
#         echo "Starting test container..."
#         docker run -d -p 8080:80 --name test-blog welblog:latest
        
#         echo "Waiting for container to be ready..."
#         sleep 5
        
#         echo "Testing HTTP response..."
#         curl -f http://localhost:8080 || exit 1
        
#         echo "Checking container logs..."
#         docker logs test-blog
        
#         echo "Stopping test container..."
#         docker stop test-blog
#         docker rm test-blog
        
#         echo "âœ… All tests passed!"
    
#     - name: ðŸ“Š Generate summary
#       run: |
#         echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Build Information" >> $GITHUB_STEP_SUMMARY
#         echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Short SHA**: \`$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
#         echo "- **Tag**: \`welblog:$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Size**: \`$(docker images welblog:latest --format '{{.Size}}')\`" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Test Results" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Container health check passed" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… HTTP response test passed" >> $GITHUB_STEP_SUMMARY