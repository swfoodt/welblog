name: Docker Build, Push and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_IMAGE: welblog
  ENABLE_DEPLOY: true

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ===== æž„å»ºé˜¶æ®µ =====
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: 'latest'
        extended: true
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    
    - name: ðŸ”¨ Build Hugo site
      run: |
        echo "Building site..."
        npm run build
        
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Build failed"
          exit 1
        fi
        
        echo "âœ… Site built successfully"
    
    - name: ðŸ³ Build Docker image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        echo "Building Docker image..."
        docker build \
          -t $DOCKER_USERNAME/$DOCKER_IMAGE:$SHORT_SHA \
          -t $DOCKER_USERNAME/$DOCKER_IMAGE:latest \
          .
        
        echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
        echo "âœ… Docker image built"
    
    # ===== æµ‹è¯•é˜¶æ®µ =====
    - name: ðŸ§ª Test Docker container
      run: |
        echo "Starting test container..."
        docker run -d -p 8080:80 --name test $DOCKER_USERNAME/$DOCKER_IMAGE:latest
        
        sleep 5
        
        echo "Testing HTTP response..."
        curl -f http://localhost:8080 || exit 1
        
        echo "Container logs:"
        docker logs test
        
        docker stop test
        docker rm test
        
        echo "âœ… All tests passed"
    
    # ===== æŽ¨é€åˆ°Docker Hubï¼ˆç‰ˆæœ¬å¤‡ä»½ï¼‰=====
    - name: ðŸ“¤ Login to Docker Hub
      if: github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ðŸ“¤ Push to Docker Hub (Version Backup)
      if: github.event_name == 'push'
      run: |
        echo "Pushing to Docker Hub for version backup..."
        
        docker push $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}
        docker push $DOCKER_USERNAME/$DOCKER_IMAGE:latest
        
        echo "âœ… Images backed up to Docker Hub"
        echo "- $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}"
        echo "- $DOCKER_USERNAME/$DOCKER_IMAGE:latest"
    
    # ===== å¯¼å‡ºé•œåƒç”¨äºŽéƒ¨ç½² =====
    - name: ðŸ“¦ Export image for deployment
      if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
      run: |
        echo "Exporting Docker image..."
        
        # å¯¼å‡ºé•œåƒ
        docker save -o welblog-${{ env.IMAGE_TAG }}.tar \
          $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}
        
        # åŽ‹ç¼©
        gzip welblog-${{ env.IMAGE_TAG }}.tar
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -lh welblog-${{ env.IMAGE_TAG }}.tar.gz
        
        SIZE=$(du -h welblog-${{ env.IMAGE_TAG }}.tar.gz | cut -f1)
        echo "Compressed image size: $SIZE"
        echo "IMAGE_FILE_SIZE=$SIZE" >> $GITHUB_ENV
    
    # ===== éƒ¨ç½²é˜¶æ®µ =====
    - name: ðŸ“¤ Transfer image to server
      if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "welblog-${{ env.IMAGE_TAG }}.tar.gz"
        target: "/tmp/"
    
    - name: ðŸš€ Deploy on server
      if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting deployment ==="
          
          TAG=${{ env.IMAGE_TAG }}
          DOCKER_USER=${{ secrets.DOCKER_USERNAME }}
          IMAGE_FILE="/tmp/welblog-${TAG}.tar.gz"
          
          # å¯¼å…¥é•œåƒ
          echo "Importing Docker image..."
          docker load -i $IMAGE_FILE
          
          # æ‰“æ ‡ç­¾ï¼ˆæ ‡å‡†åŒ–é•œåƒåï¼‰
          docker tag ${DOCKER_USER}/welblog:${TAG} welblog:${TAG}
          docker tag ${DOCKER_USER}/welblog:${TAG} welblog:latest
          
          # åœæ­¢æ—§å®¹å™¨
          echo "Stopping old container..."
          docker stop welblog-docker 2>/dev/null || echo "No container to stop"
          docker rm welblog-docker 2>/dev/null || echo "No container to remove"
          
          # å¯åŠ¨æ–°å®¹å™¨
          echo "Starting new container..."
          docker run -d \
            --name welblog-docker \
            -p 8081:80 \
            --restart unless-stopped \
            welblog:latest
          
          # éªŒè¯
          echo "Verifying deployment..."
          sleep 3
          
          if docker ps | grep -q welblog-docker; then
            if curl -f http://localhost:8081 > /dev/null 2>&1; then
              echo "âœ… Deployment successful"
            else
              echo "âŒ Container running but health check failed"
              docker logs welblog-docker
              exit 1
            fi
          else
            echo "âŒ Container failed to start"
            docker logs welblog-docker 2>/dev/null
            exit 1
          fi
          
          # æ¸…ç†
          echo "Cleaning up..."
          rm -f $IMAGE_FILE
          
          # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°3ä¸ªç‰ˆæœ¬ï¼‰
          echo "Removing old images..."
          docker images welblog --format "{{.ID}} {{.CreatedAt}}" | \
            sort -k2 -r | tail -n +4 | awk '{print $1}' | \
            xargs -r docker rmi 2>/dev/null || true
          
          docker images ${DOCKER_USER}/welblog --format "{{.ID}} {{.CreatedAt}}" | \
            sort -k2 -r | tail -n +4 | awk '{print $1}' | \
            xargs -r docker rmi 2>/dev/null || true
          
          echo "=== Deployment completed ==="
          echo "Image: welblog:$TAG"
          echo "Container: welblog-docker"
          echo "Port: 8081"
          echo "Backup: Docker Hub (${DOCKER_USER}/welblog:${TAG})"
    
    # ===== ç”ŸæˆæŠ¥å‘Š =====
    - name: ðŸ“Š Generate summary
      if: always()
      run: |
        echo "## ðŸŽ‰ Build and Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Short SHA**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: \`$DOCKER_USERNAME/$DOCKER_IMAGE\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ env.IMAGE_FILE_SIZE }}" ]; then
          echo "- **Compressed Size**: ${{ env.IMAGE_FILE_SIZE }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Strategy" >> $GITHUB_STEP_SUMMARY
        echo "- **Backup**: Pushed to Docker Hub âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment**: Direct image transfer via SCP âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Port**: 8081" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Status" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Container tests passed" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "- âœ… Backed up to Docker Hub" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ env.ENABLE_DEPLOY }}" = "true" ]; then
          echo "- âœ… Image transferred to server" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployed to server" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Access" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Hub**: [hub.docker.com/r/$DOCKER_USERNAME/$DOCKER_IMAGE](https://hub.docker.com/r/$DOCKER_USERNAME/$DOCKER_IMAGE)" >> $GITHUB_STEP_SUMMARY
        echo "- **Server**: Port 8081" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Deployment uses direct image transfer, Docker Hub serves as version backup*" >> $GITHUB_STEP_SUMMARY


# å®Œæ•´ç‰ˆï¼ˆæž„å»ºã€æµ‹è¯•ã€æŽ¨é€å’Œéƒ¨ç½², é€šè¿‡docker hubä¸Šä¼ ä»¥åŠæ‹‰å–ï¼‰
# name: Docker Build, Test and Deploy

# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]
#   workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# env:
#   DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
#   DOCKER_IMAGE: welblog
#   ENABLE_DEPLOY: false  # é“¾æŽ¥åˆ°æœåŠ¡å™¨å¯åŠ¨éƒ¨ç½²æµç¨‹

# jobs:
#   build-test-deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     # ===== æž„å»ºé˜¶æ®µ =====
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v4
    
#     - name: ðŸ”§ Setup Hugo
#       uses: peaceiris/actions-hugo@v3
#       with:
#         hugo-version: 'latest'
#         extended: true
    
#     - name: ðŸ”§ Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'
    
#     - name: ðŸ“¦ Install dependencies
#       run: npm ci
    
#     - name: ðŸ”¨ Build Hugo site
#       run: |
#         echo "Building site..."
#         npm run build
        
#         if [ ! -f "public/index.html" ]; then
#           echo "âŒ Build failed: index.html not found"
#           exit 1
#         fi
        
#         echo "âœ… Site build completed"
    
#     - name: ðŸ³ Build Docker image
#       run: |
#         SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
#         echo "Building Docker image..."
#         docker build \
#           -t $DOCKER_USERNAME/$DOCKER_IMAGE:$SHORT_SHA \
#           -t $DOCKER_USERNAME/$DOCKER_IMAGE:latest \
#           .
        
#         echo "âœ… Docker image built successfully"
#         echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
    
#     # ===== æµ‹è¯•é˜¶æ®µ =====
#     - name: ðŸ§ª Test Docker container
#       run: |
#         echo "Starting test container..."
#         docker run -d -p 8080:80 --name test-blog $DOCKER_USERNAME/$DOCKER_IMAGE:latest
        
#         echo "Waiting for container..."
#         sleep 5
        
#         echo "Testing HTTP response..."
#         curl -f http://localhost:8080 || exit 1
        
#         echo "Checking container health..."
#         docker ps | grep test-blog
        
#         echo "Container logs:"
#         docker logs test-blog
        
#         echo "Cleaning up..."
#         docker stop test-blog
#         docker rm test-blog
        
#         echo "âœ… All tests passed"
    
#     # ===== æŽ¨é€é˜¶æ®µï¼ˆå¯é€‰ï¼‰=====
#     - name: ðŸ“¤ Login to Docker Hub
#       #if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
#       uses: docker/login-action@v3
#       with:
#         username: ${{ secrets.DOCKER_USERNAME }}
#         password: ${{ secrets.DOCKER_PASSWORD }}
    
#     - name: ðŸ“¤ Push to Docker Hub
#       #if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
#       run: |
#         echo "Pushing images to Docker Hub..."
        
#         docker push $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}
#         docker push $DOCKER_USERNAME/$DOCKER_IMAGE:latest
        
#         echo "âœ… Images pushed successfully"
#         echo "- $DOCKER_USERNAME/$DOCKER_IMAGE:${{ env.IMAGE_TAG }}"
#         echo "- $DOCKER_USERNAME/$DOCKER_IMAGE:latest"
    
#     # ===== éƒ¨ç½²é˜¶æ®µï¼ˆå¯é€‰ï¼‰=====
#     - name: ðŸš€ Deploy to server
#       if: env.ENABLE_DEPLOY == 'true' && github.event_name == 'push'
#       uses: appleboy/ssh-action@v1.0.3
#       with:
#         host: ${{ secrets.SERVER_HOST }}
#         username: ${{ secrets.SERVER_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           echo "=== Starting deployment ==="
          
#           # ç™»å½•Docker Hub
#           echo "Logging in to Docker Hub..."
#           echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
#           # æ‹‰å–æœ€æ–°é•œåƒ
#           echo "Pulling latest image..."
#           docker pull ${{ secrets.DOCKER_USERNAME }}/welblog:latest
          
#           # åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
#           echo "Stopping old container..."
#           docker stop welblog-docker 2>/dev/null || echo "No container to stop"
#           docker rm welblog-docker 2>/dev/null || echo "No container to remove"
          
#           # å¯åŠ¨æ–°å®¹å™¨ï¼ˆç«¯å£8081ï¼Œä¸å½±å“ä¼ ç»Ÿéƒ¨ç½²çš„80ç«¯å£ï¼‰
#           echo "Starting new container..."
#           docker run -d \
#             --name welblog-docker \
#             -p 8081:80 \
#             --restart unless-stopped \
#             ${{ secrets.DOCKER_USERNAME }}/welblog:latest
          
#           # éªŒè¯éƒ¨ç½²
#           echo "Waiting for container to start..."
#           sleep 5
          
#           echo "Verifying deployment..."
#           docker ps | grep welblog-docker || exit 1
#           curl -f http://localhost:8081 || exit 1
          
#           # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°çš„2ä¸ªç‰ˆæœ¬ï¼‰
#           echo "Cleaning up old images..."
#           docker image prune -a -f --filter "until=72h" || true
          
#           echo "=== Deployment successful ==="
#           echo "Container running on port 8081"
    
#     # ===== ç”ŸæˆæŠ¥å‘Š =====
#     - name: ðŸ“Š Generate summary
#       if: always()
#       run: |
#         echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Build Information" >> $GITHUB_STEP_SUMMARY
#         echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Short SHA**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
#         echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
#         echo "- **Repository**: \`$DOCKER_USERNAME/$DOCKER_IMAGE\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Tag**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Size**: \`$(docker images $DOCKER_USERNAME/$DOCKER_IMAGE:latest --format '{{.Size}}')\`" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Status" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Container tests passed" >> $GITHUB_STEP_SUMMARY
        
#         if [ "${{ env.ENABLE_DEPLOY }}" = "true" ]; then
#           echo "- âœ… Pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
#           echo "- âœ… Deployed to server (port 8081)" >> $GITHUB_STEP_SUMMARY
#         else
#           echo "- â­ï¸ Deployment skipped (ENABLE_DEPLOY=false)" >> $GITHUB_STEP_SUMMARY
#         fi

# ç®€åŒ–ç‰ˆï¼ˆä»…æž„å»ºå’Œæµ‹è¯•ï¼‰
# ---------------------------------
# name: Docker Build and Test

# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]

# jobs:
#   build-and-test:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v4
    
#     - name: ðŸ”§ Setup Hugo
#       uses: peaceiris/actions-hugo@v3
#       with:
#         hugo-version: 'latest'
#         extended: true
    
#     - name: ðŸ”§ Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'
#         cache: 'npm'
    
#     - name: ðŸ“¦ Install dependencies
#       run: npm ci
    
#     - name: ðŸ”¨ Build Hugo site
#       run: |
#         echo "Building site..."
#         npm run build
        
#         if [ ! -f "public/index.html" ]; then
#           echo "âŒ Build failed: index.html not found"
#           exit 1
#         fi
        
#         echo "âœ… Build completed successfully"
    
#     - name: ðŸ³ Build Docker image
#       run: |
#         SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
#         echo "Building Docker image with tag: $SHORT_SHA"
#         docker build -t welblog:$SHORT_SHA -t welblog:latest .
        
#         echo "âœ… Docker image built successfully"
    
#     - name: ðŸ§ª Test Docker container
#       run: |
#         echo "Starting test container..."
#         docker run -d -p 8080:80 --name test-blog welblog:latest
        
#         echo "Waiting for container to be ready..."
#         sleep 5
        
#         echo "Testing HTTP response..."
#         curl -f http://localhost:8080 || exit 1
        
#         echo "Checking container logs..."
#         docker logs test-blog
        
#         echo "Stopping test container..."
#         docker stop test-blog
#         docker rm test-blog
        
#         echo "âœ… All tests passed!"
    
#     - name: ðŸ“Š Generate summary
#       run: |
#         echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Build Information" >> $GITHUB_STEP_SUMMARY
#         echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Short SHA**: \`$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
#         echo "- **Tag**: \`welblog:$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
#         echo "- **Size**: \`$(docker images welblog:latest --format '{{.Size}}')\`" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Test Results" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… Container health check passed" >> $GITHUB_STEP_SUMMARY
#         echo "- âœ… HTTP response test passed" >> $GITHUB_STEP_SUMMARY